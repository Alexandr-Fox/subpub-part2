# Subscription-Publisher Часть 2: gRPC сервис подписок

[![Go](https://img.shields.io/badge/Go-1.20+-blue.svg)](https://golang.org/)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)
[![Part 1](https://img.shields.io/badge/Part--1-Alexandr--Fox%2Fsubpub-blue)](https://github.com/Alexandr-Fox/subpub)

Это вторая часть реализации сервиса подписок, основанная на пакете [subpub](https://github.com/Alexandr-Fox/subpub) из первой части. Сервис предоставляет gRPC API для подписки на события и их публикации.

## Содержание
1. [Как работает сервис](#как-работает-сервис)
2. [Сборка и запуск](#сборка-и-запуск)
3. [Конфигурация](#конфигурация)
4. [Логирование и мониторинг](#логирование-и-мониторинг)
5. [Использованные паттерны](#использованные-паттерны)
6. [Примеры клиентов](#клиенты-для-работы-с-grpc-сервисом-подписок)

## Как работает сервис

Сервис реализует паттерн Publisher-Subscriber через gRPC API:
- Клиенты могут подписываться на события по ключу (topic)
- Издатели могут публиковать события для всех подписчиков ключа
- Каждый подписчик получает события в том же порядке, в котором они были опубликованы (FIFO)
- Поддерживается множество подписчиков на один ключ
- Медленные подписчики не блокируют других

Основные компоненты:
- **gRPC сервер** - обрабатывает запросы подписки и публикации
- **Ядро subpub** - из первой части проекта, обеспечивает доставку сообщений
- **Метрики Prometheus** - мониторинг работы сервиса
- **Логирование Sentry** - логирование ошибок и анализ производительности сервиса
- **Конфигурация** - настройка параметров через YAML файл

## Сборка и запуск

### Требования
- **Go 1.20+** 

### 1. Клонирование репозитория
```bash
git clone https://github.com/Alexandr-Fox/subpub-part2.git
cd subpub-part2
```

### 2. Настройка конфигурации
Создайте файл `config/config.yml` на основе примера:
```bash
cp config/config-example.yml config/config.yml
```

Отредактируйте параметры в `config/config.yml` (см. раздел [Конфигурация](#конфигурация)).

### 3. Сборка сервера
```bash
go build -o server server.go
```

### 4. Запуск сервера
```bash
./server
```


## Альтернативный вариант: запуск через Docker
```bash
docker-compose up --build
```


## Конфигурация

Файл конфигурации `config/config.yml` содержит следующие параметры:

```yaml
server:
  grpc:
    host: "0.0.0.0"                # Хост для gRPC сервера
    port: 50051                    # Порт для gRPC сервера
    max_connection_age: "30s"      # Макс. время жизни соединения
    max_connection_age_grace: "5s" # Время на завершение операций
  
  shutdown_timeout: "15s" # Таймаут для graceful shutdown

sentry:
   dsn: "your_sentry_dsn"     # DSN строка sentry
   environment: "production"  # Тип среды "production" или "development" для фильтрации событий в sentry
   debug: true                # Включить режим отладки в sentry
   release: "subpub-grpc@1.0" # Название релиза для фильтрации в sentry
   send_default_pii: true     # Отправлять пользовательскую информацию по умолчанию в sentry

logging:
  host: "0.0.0.0" # Хост для prometheus сервера
  port: 9091      # Порт для prometheus сервера
```

## Логирование и мониторинг

### Логирование

- Сервер поддерживает логирование, которое выводит базовую информацию об ошибках и опубликованных сообщениях в консоль в текстовом виде.

### Логирование Sentry

Сервис отправляет информацию об ошибках и запросах, вызвавших их в сервис Sentry

Основная собираемая информация:
- Трассировка стека
- Данные для запроса
- Вызванный метод (например /PubSub/Publish)
- Статистика скорости обработки запросов
- Статистика по числу ошибок на каждый метод

### Метрики Prometheus

Сервис предоставляет метрики по адресу `http://localhost:9091/metrics`:

Основные метрики:
- `pubsub_active_subscribers` - количество активных подписчиков
- `pubsub_messages_published_total` - опубликованные сообщения
- `pubsub_messages_delivered_total` - доставленные сообщения
- `pubsub_message_delivery_latency_seconds` - задержка доставки

## Использованные паттерны

1. **Dependency Injection**:
    - Сервисы инициализируются с зависимостями через конструкторы
    - Легко подменить реализации для тестирования

2. **Graceful Shutdown**:
    - Корректная обработка сигналов завершения
    - Завершение активных соединений с таймаутом
    - Приоритетная остановка принятия новых соединений

3. **Publisher-Subscriber**:
    - Ядро сервиса из первой части
    - Гарантированная доставка сообщений в порядке публикации

4. **Конфигурация через интерфейсы**:
    - Четкое разделение интерфейсов и реализаций
    - Легкое расширение функциональности

## Клиенты для работы с gRPC сервисом подписок

Сервис включает два клиентских приложения:

1. **Publisher** - для публикации сообщений
2. **Subscriber** - для подписки на получение сообщений

---

### 1. Клиент Publisher

Отправляет сообщения на указанный топик gRPC сервера.

#### Использование

```bash
./publisher -host <адрес_сервера> -topic <имя_топика> -message "<текст_сообщения>"
```

#### Параметры

| Параметр   | Обязательный | По умолчанию      | Описание                     |
|------------|--------------|-------------------|------------------------------|
| `-host`    | Нет          | `localhost:50051` | Адрес gRPC сервера           |
| `-topic`   | Нет          | `default`         | Название топика              |
| `-message` | **Да**       | -                 | Текст сообщения для отправки |

#### Примеры

```bash
# Отправка сообщения на локальный сервер
./publisher -message "Hello World"

# Отправка сообщения на удаленный сервер
./publisher -host grpc.example.com:50051 -topic updates -message "System update"
```

#### Особенности

- После отправки сообщения клиент завершает работу
- Таймаут соединения - 5 секунд
- Требует обязательного указания сообщения

---

### 2. Клиент Subscriber

Подписывается на сообщения из указанного топика и выводит их в консоль.

#### Использование

```bash
./subscriber -host <адрес_сервера> -topic <имя_топика>
```

#### Параметры

| Параметр | Обязательный | По умолчанию      | Описание                     |
|----------|--------------|-------------------|------------------------------|
| `-host`  | Нет          | `localhost:50051` | Адрес gRPC сервера           |
| `-topic` | Нет          | `default`         | Название топика для подписки |

#### Примеры

```bash
# Подписка на локальный сервер
./subscriber

# Подписка на удаленный сервер
./subscriber -host grpc.example.com:50051 -topic updates
```

#### Особенности

- Работает в постоянном режиме до принудительного завершения
- Поддерживает graceful shutdown (Ctrl+C)
- Выводит полученные сообщения в консоль в реальном времени

---

## Сборка клиентов

1. Соберите исполняемые файлы:
   ```bash
   go build -o publisher publisher.go
   go build -o subscriber subscriber.go
   ```

2. Для кроссплатформенной сборки укажите ОС и архитектуру:
   ```bash
   GOOS=linux GOARCH=amd64 go build -o publisher publisher.go
   ```

---

> Оба клиента используют insecure-соединение по умолчанию. Для защищенного соединения необходимо настроить TLS.

## Лицензия

Проект распространяется под лицензией MIT - см. файл [LICENSE](LICENSE).